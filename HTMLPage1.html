<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Заявка на тур • ВКО</title>

    <!-- Ваш основной CSS -->
    <link rel="stylesheet" href="css_1.css">
</head>

<body>
    <section class="apply-page">
        <div class="apply-wrap">

            <div class="apply-head">
                <h1 class="apply-title">Заявка на тур по ВКО</h1>
                <p class="apply-sub">Заполните форму — мы подберём маршрут и свяжемся с вами.</p>
            </div>

            <form class="apply-form" id="applyForm" novalidate>
                <div class="apply-grid">

                    <div class="apply-field">
                        <label for="fullName">ФИО *</label>
                        <input id="fullName"
                               name="fullName"
                               type="text"
                               placeholder="Напр.: Тамурдай Есиммов"
                               required
                               autocomplete="name" />
                        <div class="apply-error" data-err="fullName"></div>
                    </div>

                    <div class="apply-field">
                        <label for="phone">Номер телефона *</label>
                        <input id="phone"
                               name="phone"
                               type="tel"
                               placeholder="+7 777 000 00 00"
                               required
                               autocomplete="tel" />
                        <div class="apply-hint">Формат: +7… или 8… (не менее 10 цифр)</div>
                        <div class="apply-error" data-err="phone"></div>
                    </div>

                    <div class="apply-field">
                        <label for="startPoint">Место старта *</label>
                        <input id="startPoint"
                               name="startPoint"
                               type="text"
                               list="vkoPoints"
                               placeholder="Напр.: Өскемен"
                               required />
                        <div class="apply-error" data-err="startPoint"></div>
                    </div>

                    <div class="apply-field">
                        <label for="endPoint">Куда хотите поехать *</label>
                        <input id="endPoint"
                               name="endPoint"
                               type="text"
                               list="vkoPlaces"
                               placeholder="Напр.: Маркаколь"
                               required />
                        <div class="apply-error" data-err="endPoint"></div>
                    </div>

                    <div class="apply-field">
                        <label for="guide">Гид *</label>
                        <select id="guide" name="guide" required>
                            <option value="" selected disabled>Выберите гида</option>
                            <option value="Айдана">Айдана (Алтай, горы)</option>
                            <option value="Ерлан">Ерлан (Маркаколь, озёра)</option>
                            <option value="Дина">Дина (семейные туры)</option>
                            <option value="Тимур">Тимур (треккинг)</option>
                            <option value="Алина">Алина (фото-туры)</option>
                            <option value="Нурсултан">Нурсултан (авто-маршруты)</option>
                            <option value="Подбор">Подберите мне гида</option>
                        </select>
                        <div class="apply-error" data-err="guide"></div>
                    </div>

                    <div class="apply-field">
                        <label for="date">Дата поездки *</label>
                        <input id="date" name="date" type="date" required />
                        <div class="apply-error" data-err="date"></div>
                    </div>

                    <div class="apply-field">
                        <label for="people">Количество людей *</label>
                        <input id="people"
                               name="people"
                               type="number"
                               min="1"
                               step="1"
                               value="1"
                               required />
                        <div class="apply-error" data-err="people"></div>
                    </div>

                    <div class="apply-field apply-field-wide">
                        <label for="comment">Комментарий *</label>
                        <textarea id="comment"
                                  name="comment"
                                  rows="5"
                                  placeholder="Уровень сложности, предпочтения, транспорт и т.д."
                                  required></textarea>
                        <div class="apply-error" data-err="comment"></div>
                    </div>

                </div>

                <div class="apply-actions">
                    <button class="send-btn" type="submit">Отправить заявку</button>
                    <button class="apply-reset" type="reset">Очистить</button>
                </div>

                <!-- Сообщение об успехе -->
                <div class="apply-success" id="applySuccess" role="status" aria-live="polite"></div>
            </form>

            <!-- datalist подсказки -->
            <datalist id="vkoPoints">
                <option value="Өскемен / Усть-Каменогорск"></option>
                <option value="Риддер"></option>
                <option value="Алтай (Зыряновск)"></option>
                <option value="Серебрянск"></option>
                <option value="Зайсан"></option>
                <option value="Курчум"></option>
                <option value="Катон-Карагай"></option>
                <option value="Маркаколь"></option>
                <option value="Шемонаиха"></option>
                <option value="Глубокое"></option>
            </datalist>

            <datalist id="vkoPlaces">
                <option value="Алтай (Катон-Карагай)"></option>
                <option value="Маркаколь"></option>
                <option value="Бухтарминское водохранилище"></option>
                <option value="Озеро Зайсан"></option>
                <option value="Ледник Белуха"></option>
                <option value="Сибинские озёра"></option>
                <option value="Ак-Баур"></option>
            </datalist>

        </div>
    </section>

    <script>
        // 1) Применяем тему как на главной (берём из localStorage)
        (function applyThemeFromStorage() {
            if (localStorage.getItem("theme") === "green") {
                document.body.classList.add("green");
            } else {
                document.body.classList.remove("green");
            }
        })();

        // 2) Валидация + сохранение в localStorage
        const form = document.getElementById("applyForm");
        const success = document.getElementById("applySuccess");

        function setError(fieldName, message) {
            const box = document.querySelector(`.apply-error[data-err="${fieldName}"]`);
            if (box) box.textContent = message || "";
        }

        function onlyDigits(s) {
            return String(s || "").replace(/\D/g, "");
        }

        function isPastDate(dateStr) {
            if (!dateStr) return true;
            const chosen = new Date(dateStr + "T00:00:00");
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return chosen < today;
        }

        // Запрет выбора даты в прошлом (HTML-уровень)
        (function setMinDate() {
            const dateInput = document.getElementById("date");
            if (!dateInput) return;
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, "0");
            const dd = String(now.getDate()).padStart(2, "0");
            dateInput.min = `${yyyy}-${mm}-${dd}`;
        })();

        form.addEventListener("submit", (e) => {
            e.preventDefault();
            success.textContent = "";

            // очистить ошибки
            ["fullName", "phone", "startPoint", "endPoint", "guide", "date", "people", "comment"]
                .forEach(k => setError(k, ""));

            const data = new FormData(form);
            const fullName = (data.get("fullName") || "").toString().trim();
            const phoneRaw = (data.get("phone") || "").toString().trim();
            const startPoint = (data.get("startPoint") || "").toString().trim();
            const endPoint = (data.get("endPoint") || "").toString().trim();
            const guide = (data.get("guide") || "").toString().trim();
            const date = (data.get("date") || "").toString().trim();
            const people = (data.get("people") || "").toString().trim();
            const comment = (data.get("comment") || "").toString().trim();

            let ok = true;

            if (!fullName) { setError("fullName", "Введите ФИО."); ok = false; }

            const phoneDigits = onlyDigits(phoneRaw);
            if (!phoneRaw || phoneDigits.length < 10) { setError("phone", "Введите корректный номер телефона."); ok = false; }

            if (!startPoint) { setError("startPoint", "Укажите место старта."); ok = false; }
            if (!endPoint) { setError("endPoint", "Укажите направление/локацию."); ok = false; }

            if (!guide) { setError("guide", "Выберите гида."); ok = false; }

            if (!date) { setError("date", "Выберите дату."); ok = false; }
            else if (isPastDate(date)) { setError("date", "Дата не может быть в прошлом."); ok = false; }

            const nPeople = Number(people);
            if (!Number.isFinite(nPeople) || nPeople < 1) { setError("people", "Количество людей: минимум 1."); ok = false; }

            if (!comment) { setError("comment", "Добавьте комментарий (обязательное поле)."); ok = false; }

            if (!ok) return;

            const payload = {
                id: "app_" + Date.now(),
                createdAt: new Date().toISOString(),
                fullName,
                phone: phoneRaw,
                startPoint,
                endPoint,
                guide,
                date,
                people: nPeople,
                comment
            };

            const key = "vko_applications";
            const list = JSON.parse(localStorage.getItem(key) || "[]");
            list.unshift(payload);
            localStorage.setItem(key, JSON.stringify(list));

            form.reset();
            document.getElementById("people").value = "1";

            success.textContent = "Заявка отправлена и сохранена. Мы свяжемся с вами по указанному номеру.";
        });
    </script>
</body>
</html>
